{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>LiteLLM Models</h2>
  {% if litellm_error %}
  <p class="muted">{{ litellm_error }}</p>
  {% else %}
  <p class="muted">Fetched at {{ fetched_at or "Unknown" }}</p>
  {% if litellm_models %}
  <ul class="model-cards">
    {% for model in litellm_models %}
    {% set mappable = model.litellm_mappable %}
    <li class="model-card">
      <div class="model-card__header">
        <div>{{ model.id }}</div>
        <div class="model-card__meta">
          {% if model.mode %}
          <span class="badge">Mode: {{ model.mode }}</span>
          {% endif %}
          {% if model.max_tokens %}
          <span class="badge">Max tokens: {{ "{:,}".format(model.max_tokens) }}</span>
          {% endif %}
          {% if model.max_input_tokens %}
          <span class="badge">Max input: {{ "{:,}".format(model.max_input_tokens) }}</span>
          {% elif model.context_window %}
          <span class="badge">Ctx: {{ "{:,}".format(model.context_window) }} tokens</span>
          {% endif %}
          {% if model.max_output_tokens %}
          <span class="badge">Max output: {{ "{:,}".format(model.max_output_tokens) }} tokens</span>
          {% endif %}
          {% if model.capabilities %}
          <span class="badge">Capabilities: {{ model.capabilities | join(", ") }}</span>
          {% endif %}
          {% if model.model_type %}
          <span class="badge">Tipo: {{ model.model_type }}</span>
          {% endif %}
        </div>
      </div>
      <div class="model-card__body">
        {% set summary_parts = [] %}
        {% if model.model_type %}
        {% set _ = summary_parts.append("Tipo: " ~ model.model_type) %}
        {% endif %}
        {% if model.mode %}
        {% set _ = summary_parts.append("Modo: " ~ model.mode) %}
        {% endif %}
        {% if model.capabilities %}
        {% set _ = summary_parts.append("Capacidades: " ~ (model.capabilities | join(", "))) %}
        {% endif %}
        {% set pricing_parts = [] %}
        {% if mappable.get("input_cost_per_token") %}
        {% set _ = pricing_parts.append("Input: $" ~ "{:.4f}".format(mappable["input_cost_per_token"] * 1000) ~ "/1K tokens") %}
        {% endif %}
        {% if mappable.get("output_cost_per_token") %}
        {% set _ = pricing_parts.append("Output: $" ~ "{:.4f}".format(mappable["output_cost_per_token"] * 1000) ~ "/1K tokens") %}
        {% endif %}
        {% if mappable.get("input_cost_per_second") %}
        {% set _ = pricing_parts.append("Audio: $" ~ "{:.4f}".format(mappable["input_cost_per_second"] * 60) ~ "/minute") %}
        {% endif %}
        {% if mappable.get("output_cost_per_image") %}
        {% set _ = pricing_parts.append("Image: $" ~ "{:.2f}".format(mappable["output_cost_per_image"]) ~ "/image") %}
        {% endif %}
        {% if pricing_parts %}
        {% set _ = summary_parts.append("Precios (ref. OpenAI): " ~ (pricing_parts | join(", "))) %}
        {% endif %}
        {% if summary_parts %}
        {{ summary_parts | join(" · ") }}
        {% else %}
        <span class="muted">Sin información resumida disponible.</span>
        {% endif %}
      </div>
      <div class="model-card__actions">
        <button type="button" class="toggle-details" data-index="{{ loop.index0 }}">
          Ver parámetros LiteLLM
        </button>
      </div>
      <details class="model-card__details">
        <summary style="display: none;"></summary>
        <div class="model-card__details-content">
          <p class="muted">Parámetros mapeables a la definición de LiteLLM:</p>
          {% if mappable %}
          <pre class="model-card__body" data-type="mappable"></pre>
          {% else %}
          <p class="muted">No se encontraron parámetros específicos de LiteLLM en la respuesta.</p>
          {% endif %}
          <p class="muted">Respuesta completa del endpoint:</p>
          <pre class="model-card__body" data-type="raw"></pre>
        </div>
      </details>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No models were returned by the LiteLLM endpoint.</p>
  {% endif %}
  {% endif %}
</section>
<script>
  // Store model data for display
  const modelData = [
    {% for model in litellm_models %}
    {
      mappable: {{ model.litellm_mappable | tojson | safe }},
      raw: {{ model.raw | tojson | safe }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  // Clean JSON by removing null, empty strings, and empty objects/arrays
  function cleanJSON(obj) {
    if (obj === null || obj === undefined) return null;
    if (typeof obj !== 'object') return obj;

    if (Array.isArray(obj)) {
      const cleaned = obj.map(cleanJSON).filter(item => item !== null);
      return cleaned.length > 0 ? cleaned : null;
    }

    const cleaned = {};
    for (const [key, value] of Object.entries(obj)) {
      const cleanedValue = cleanJSON(value);
      if (cleanedValue !== null && cleanedValue !== '' &&
          !(Array.isArray(cleanedValue) && cleanedValue.length === 0) &&
          !(typeof cleanedValue === 'object' && Object.keys(cleanedValue).length === 0)) {
        cleaned[key] = cleanedValue;
      }
    }

    return Object.keys(cleaned).length > 0 ? cleaned : null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.toggle-details').forEach((button) => {
      button.addEventListener('click', () => {
        const index = parseInt(button.dataset.index);
        const card = button.closest('.model-card');
        const details = card.querySelector('.model-card__details');
        const mappablePre = card.querySelector('pre[data-type="mappable"]');
        const rawPre = card.querySelector('pre[data-type="raw"]');

        // Toggle details
        const isOpen = details.open;
        if (!isOpen) {
          // Populate with cleaned JSON when opening
          if (mappablePre && modelData[index]) {
            const cleanedMappable = cleanJSON(modelData[index].mappable);
            mappablePre.textContent = JSON.stringify(cleanedMappable, null, 2);
          }
          if (rawPre && modelData[index]) {
            const cleanedRaw = cleanJSON(modelData[index].raw);
            rawPre.textContent = JSON.stringify(cleanedRaw, null, 2);
          }
          details.open = true;
          button.textContent = 'Ocultar información';
        } else {
          details.open = false;
          button.textContent = 'Ver parámetros LiteLLM';
        }
      });
    });
  });
</script>
{% endblock %}
