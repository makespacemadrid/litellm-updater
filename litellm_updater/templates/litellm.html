{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>LiteLLM Models</h2>
  {% if litellm_error %}
  <p class="muted">{{ litellm_error }}</p>
  {% else %}
  <p class="muted">Fetched at {{ fetched_at or "Unknown" }}</p>
  {% if litellm_models %}
  <!-- Bulk Actions Bar -->
  <div class="bulk-actions bulk-actions--hidden" id="bulkActions">
    <div class="bulk-actions__info">
      <span id="selectedCount">0</span> modelos seleccionados
    </div>
    <div class="bulk-actions__buttons">
      <button type="button" class="btn-delete" id="bulkDelete">
        Eliminar seleccionados
      </button>
      <button type="button" id="bulkCancel">
        Cancelar
      </button>
    </div>
  </div>
  <ul class="model-cards">
    {% for model in litellm_models %}
    {% set mappable = model.litellm_fields %}
    <li class="model-card" data-model-id="{{ model.id }}">
      <!-- Checkbox -->
      <div class="model-card__checkbox">
        <input type="checkbox" class="model-checkbox" value="{{ model.id }}">
      </div>

      <!-- Model Header -->
      <div class="model-card__header">
        <div class="model-card__title">{{ model.id }}</div>
        {% if model.raw.get('details') %}
        {% set details = model.raw.details %}
        <div class="model-card__subtitle">
          {% if details.get('family') %}{{ details.family }}{% endif %}
          {% if details.get('parameter_size') %}
            {% if details.get('family') %} • {% endif %}{{ details.parameter_size }}
          {% endif %}
          {% if details.get('quantization_level') %}
            {% if details.get('family') or details.get('parameter_size') %} • {% endif %}{{ details.quantization_level }}
          {% endif %}
        </div>
        {% endif %}
      </div>

      <!-- Model Info -->
      <div class="model-card__info">
        <!-- Context Window -->
        {% if model.max_input_tokens or model.context_window %}
        <span class="badge">
          Context: {{ "{:,}".format(model.max_input_tokens or model.context_window) }}
        </span>
        {% endif %}

        <!-- Capabilities -->
        {% if model.capabilities %}
        {% for capability in model.capabilities[:3] %}
        <span class="badge badge-support">{{ capability }}</span>
        {% endfor %}
        {% if model.capabilities|length > 3 %}
        <span class="badge">+{{ model.capabilities|length - 3 }} más</span>
        {% endif %}
        {% endif %}
      </div>

      <!-- Actions -->
      <div class="model-card__actions">
        <button type="button" class="btn-info toggle-details" data-index="{{ loop.index0 }}">
          Info
        </button>
        <button type="button" class="btn-delete model-delete" data-model-id="{{ model.id }}">
          Delete
        </button>
      </div>

      <!-- Details (hidden by default) -->
      <details class="model-card__details" style="grid-column: 1 / -1; margin-top: 0.5rem;">
        <summary style="display: none;"></summary>
        <div class="model-card__details-content">
          <div class="litellm-fields-preview">
            <p class="muted">Parámetros mapeables a la definición de LiteLLM:</p>
            {% if mappable %}
            <pre class="model-card__body" data-type="mappable"></pre>
            {% else %}
            <p class="muted">No se encontraron parámetros específicos de LiteLLM en la respuesta.</p>
            {% endif %}
          </div>
          <details class="raw-data-toggle">
            <summary>Ver datos completos (JSON)</summary>
            <pre class="raw-data-json" data-type="raw"></pre>
          </details>
        </div>
      </details>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No models were returned by the LiteLLM endpoint.</p>
  {% endif %}
  {% endif %}
</section>
<script>
  // Store model data for display
  const modelData = [
    {% for model in litellm_models %}
    {
      mappable: {{ model.litellm_fields | tojson | safe }},
      raw: {{ model.raw | tojson | safe }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  // Clean JSON by removing null, empty strings, and empty objects/arrays
  function cleanJSON(obj) {
    if (obj === null || obj === undefined) return null;
    if (typeof obj !== 'object') return obj;

    if (Array.isArray(obj)) {
      const cleaned = obj.map(cleanJSON).filter(item => item !== null);
      return cleaned.length > 0 ? cleaned : null;
    }

    const cleaned = {};
    for (const [key, value] of Object.entries(obj)) {
      const cleanedValue = cleanJSON(value);
      if (cleanedValue !== null && cleanedValue !== '' &&
          !(Array.isArray(cleanedValue) && cleanedValue.length === 0) &&
          !(typeof cleanedValue === 'object' && Object.keys(cleanedValue).length === 0)) {
        cleaned[key] = cleanedValue;
      }
    }

    return Object.keys(cleaned).length > 0 ? cleaned : null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    const checkboxes = document.querySelectorAll('.model-checkbox');

    // Update bulk actions visibility
    function updateBulkActions() {
      const checked = document.querySelectorAll('.model-checkbox:checked');
      if (checked.length > 0) {
        bulkActions.classList.remove('bulk-actions--hidden');
        selectedCount.textContent = checked.length;
      } else {
        bulkActions.classList.add('bulk-actions--hidden');
      }
    }

    // Checkbox selection
    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => {
        const card = e.target.closest('.model-card');
        if (e.target.checked) {
          card.classList.add('model-card--selected');
        } else {
          card.classList.remove('model-card--selected');
        }
        updateBulkActions();
      });
    });

    // Bulk cancel
    document.getElementById('bulkCancel')?.addEventListener('click', () => {
      checkboxes.forEach(cb => {
        cb.checked = false;
        cb.closest('.model-card').classList.remove('model-card--selected');
      });
      updateBulkActions();
    });

    // Bulk delete
    document.getElementById('bulkDelete')?.addEventListener('click', async () => {
      const checked = document.querySelectorAll('.model-checkbox:checked');
      const modelIds = Array.from(checked).map(cb => cb.value);

      if (!confirm(`¿Estás seguro de que quieres eliminar ${modelIds.length} modelos?`)) {
        return;
      }

      // TODO: Implement actual delete endpoint
      console.log('Deleting models:', modelIds);
      alert('Funcionalidad de eliminación por lotes - pendiente de implementación en el backend');
    });

    // Individual delete
    document.querySelectorAll('.model-delete').forEach((button) => {
      button.addEventListener('click', async (e) => {
        const modelId = e.target.dataset.modelId;

        if (!confirm(`¿Estás seguro de que quieres eliminar el modelo ${modelId}?`)) {
          return;
        }

        // TODO: Implement actual delete endpoint
        console.log('Deleting model:', modelId);
        alert('Funcionalidad de eliminación individual - pendiente de implementación en el backend');
      });
    });

    // Toggle details
    document.querySelectorAll('.toggle-details').forEach((button) => {
      button.addEventListener('click', () => {
        const index = parseInt(button.dataset.index);
        const card = button.closest('.model-card');
        const details = card.querySelector('.model-card__details');
        const mappablePre = card.querySelector('pre[data-type="mappable"]');
        const rawPre = card.querySelector('.raw-data-json');

        // Toggle details
        const isOpen = details.open;
        if (!isOpen) {
          // Populate with cleaned JSON when opening
          if (mappablePre && modelData[index]) {
            const cleanedMappable = cleanJSON(modelData[index].mappable);
            mappablePre.textContent = JSON.stringify(cleanedMappable, null, 2);
          }
          if (rawPre && modelData[index]) {
            const cleanedRaw = cleanJSON(modelData[index].raw);
            rawPre.textContent = JSON.stringify(cleanedRaw, null, 2);
          }
          details.open = true;
          button.textContent = 'Ocultar';
        } else {
          details.open = false;
          button.textContent = 'Info';
        }
      });
    });
  });
</script>
{% endblock %}
