{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Providers & Models (Database)</h2>
  <p class="muted">Models are loaded from the database. Orphaned models (no longer in provider) are shown in <span style="color: #d32f2f;">red</span>.</p>

  <div id="providers-container">Loading providers...</div>
</section>

<section class="panel">
  <form action="/sync" method="post">
    <button type="submit">Run sync now</button>
  </form>
</section>

<style>
.provider-block {
  margin-bottom: 2rem;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 1rem;
}

.provider-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.provider-info h3 {
  margin: 0 0 0.25rem 0;
}

.provider-info .muted {
  margin: 0;
  font-size: 0.9rem;
}

.model-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.model-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  margin: 0.5rem 0;
  background: #f9f9f9;
  border-radius: 4px;
}

.model-item.orphaned {
  background: #ffebee;
  border-left: 3px solid #d32f2f;
}

.model-item.orphaned .model-name {
  color: #d32f2f;
}

.model-info {
  flex: 1;
}

.model-name {
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.model-meta {
  font-size: 0.85rem;
  color: #666;
}

.model-actions {
  display: flex;
  gap: 0.5rem;
}

.model-actions button {
  padding: 0.4rem 0.8rem;
  font-size: 0.85rem;
}

.btn-refresh {
  background: #1976d2;
  color: white;
}

.btn-push {
  background: #388e3c;
  color: white;
}

.btn-edit {
  background: #f57c00;
  color: white;
}

.badge {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  margin: 0 0.25rem;
  background: #e0e0e0;
  border-radius: 3px;
  font-size: 0.75rem;
}

.badge.modified {
  background: #f57c00;
  color: white;
}
</style>

<script>
let providers = [];

async function loadProviders() {
  try {
    const response = await fetch('/api/providers');
    if (!response.ok) throw new Error('Failed to load providers');

    providers = await response.json();
    await renderProviders();
  } catch (error) {
    document.getElementById('providers-container').innerHTML =
      `<p style="color: red;">Error loading providers: ${error.message}</p>`;
  }
}

async function loadProviderModels(providerId) {
  const response = await fetch(`/api/providers/${providerId}/models?include_orphaned=true`);
  if (!response.ok) throw new Error('Failed to load models');
  return await response.json();
}

async function renderProviders() {
  const container = document.getElementById('providers-container');

  if (providers.length === 0) {
    container.innerHTML = '<p class="muted">No providers configured. Add providers in the admin page.</p>';
    return;
  }

  let html = '';

  for (const provider of providers) {
    try {
      const data = await loadProviderModels(provider.id);
      const models = data.models || [];

      html += `
        <div class="provider-block">
          <div class="provider-header">
            <div class="provider-info">
              <h3>${provider.name}</h3>
              <p class="muted">
                ${provider.type} — ${provider.base_url}
                ${provider.prefix ? `<br>Prefix: <strong>${provider.prefix}</strong>` : ''}
              </p>
            </div>
            <div>
              <span class="muted">${models.length} model(s)</span>
            </div>
          </div>
          ${models.length > 0 ? renderModels(provider, models) : '<p class="muted">No models synced yet</p>'}
        </div>
      `;
    } catch (error) {
      html += `
        <div class="provider-block">
          <div class="provider-header">
            <div class="provider-info">
              <h3>${provider.name}</h3>
              <p class="muted">${provider.type} — ${provider.base_url}</p>
            </div>
          </div>
          <p style="color: red;">Error loading models: ${error.message}</p>
        </div>
      `;
    }
  }

  container.innerHTML = html;
  bindModelActions();
}

function renderModels(provider, models) {
  const items = models.map(model => {
    const orphanedClass = model.is_orphaned ? 'orphaned' : '';
    const displayName = model.display_name || model.model_id;

    // Build metadata badges
    const badges = [];
    if (model.context_window) {
      badges.push(`Context: ${model.context_window.toLocaleString()}`);
    }
    if (model.capabilities && model.capabilities.length > 0) {
      badges.push(...model.capabilities.slice(0, 2));
    }

    const modifiedBadge = model.user_modified ? '<span class="badge modified">Modified</span>' : '';

    return `
      <li class="model-item ${orphanedClass}" data-model-id="${model.id}">
        <div class="model-info">
          <div class="model-name">${displayName}</div>
          <div class="model-meta">
            ${badges.map(b => `<span class="badge">${b}</span>`).join('')}
            ${modifiedBadge}
            ${model.is_orphaned ? '<span class="badge" style="background: #d32f2f; color: white;">Orphaned</span>' : ''}
          </div>
        </div>
        <div class="model-actions">
          ${!model.is_orphaned ? `<button class="btn-refresh" onclick="refreshModel(${model.id}, '${displayName}')">Refresh</button>` : ''}
          <button class="btn-push" onclick="pushModel(${model.id}, '${displayName}')">Push to LiteLLM</button>
          <button class="btn-edit" onclick="editModel(${model.id})">Edit Params</button>
        </div>
      </li>
    `;
  }).join('');

  return `<ul class="model-list">${items}</ul>`;
}

async function refreshModel(modelId, displayName) {
  if (!confirm(`Refresh "${displayName}" from provider?`)) return;

  try {
    const response = await fetch(`/api/models/db/${modelId}/refresh`, {
      method: 'POST'
    });

    const result = await response.json();

    if (response.ok) {
      alert(`✓ ${result.message}`);
      await loadProviders();
    } else {
      alert(`✗ ${result.detail || 'Refresh failed'}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

async function pushModel(modelId, displayName) {
  if (!confirm(`Push "${displayName}" to LiteLLM?`)) return;

  try {
    const response = await fetch(`/api/models/db/${modelId}/push`, {
      method: 'POST'
    });

    const result = await response.json();

    if (response.ok) {
      alert(`✓ ${result.message}`);
    } else {
      alert(`✗ ${result.detail || 'Push failed'}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

async function editModel(modelId) {
  try {
    // Fetch current model data
    const response = await fetch(`/api/models/db/${modelId}`);
    if (!response.ok) throw new Error('Failed to load model');

    const model = await response.json();
    const currentParams = model.user_params || model.litellm_params;

    // Show edit dialog
    const newParamsJson = prompt(
      `Edit parameters for ${model.display_name}\\n\\nCurrent params (JSON):`,
      JSON.stringify(currentParams, null, 2)
    );

    if (!newParamsJson) return; // User cancelled

    let newParams;
    try {
      newParams = JSON.parse(newParamsJson);
    } catch (error) {
      alert(`Invalid JSON: ${error.message}`);
      return;
    }

    // Update parameters
    const updateResponse = await fetch(`/api/models/db/${modelId}/params`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newParams)
    });

    const result = await updateResponse.json();

    if (updateResponse.ok) {
      alert(`✓ ${result.message}`);
      await loadProviders();
    } else {
      alert(`✗ ${result.detail || 'Update failed'}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

function bindModelActions() {
  // Actions are bound via onclick in the HTML
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadProviders);
</script>

{% endblock %}
