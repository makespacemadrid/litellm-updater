{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Providers</h2>
  {% if config.sources %}
  {% for source in config.sources %}
  <div class="source-block">
    <div class="source-header">
      <div>
        <h3>{{ source.name }}</h3>
        <p class="muted">{{ human_source_type(source.type) }} — {{ source.base_url }}</p>
      </div>
      <div class="source-actions">
        <form action="/providers/refresh" method="post" class="refresh-form">
          <input type="hidden" name="name" value="{{ source.name }}" />
          <button type="submit">Refresh list</button>
        </form>
      </div>
    </div>
    {% set source_models = models.get(source.name) %}
    <div class="models-area" data-source-name="{{ source.name }}" data-last-synced="{{ last_synced }}">
      <div class="models-content">
        {% if source_models %}
        <p class="muted">Last fetched at {{ source_models.fetched_at or last_synced }}</p>
        <ul class="model-cards">
          {% for model in source_models.models %}
          <li class="model-card">
            <div class="model-card__header">
              <div>{{ model.id }}</div>
              <div class="model-card__meta">
                {% if model.context_window %}
                <span class="badge">Ctx: {{ "{:,}".format(model.context_window) }} tokens</span>
                {% endif %}
                {% if model.max_output_tokens %}
                <span class="badge">Max output: {{ "{:,}".format(model.max_output_tokens) }} tokens</span>
                {% endif %}
                {% if model.capabilities %}
                <span class="badge">Capabilities: {{ model.capabilities | join(", ") }}</span>
                {% endif %}
              </div>
            </div>
            <div class="model-card__body">Metadata fetched from tags.</div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="muted">No models fetched yet for this provider.</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <p>No sources configured yet. Add providers in the admin page.</p>
  {% endif %}
</section>
<section class="panel">
  <form action="/sync" method="post">
    <button type="submit">Run sync now</button>
  </form>
</section>
<script>
  const modelsEndpoint = '/models';
  const modelDetailsEndpoint = '/models/show';

  function formatBytes(bytes) {
    if (!Number.isFinite(bytes)) return null;
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let unitIndex = 0;
    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex += 1;
    }
    return `${size.toFixed(size >= 10 || size % 1 === 0 ? 0 : 1)} ${units[unitIndex]}`;
  }

  function buildTagSummary(raw = {}) {
    const details = raw.details || {};
    const modifiedAt = raw.modified_at ? new Date(raw.modified_at).toLocaleString() : null;
    const sizeLabel = formatBytes(raw.size);
    const families = Array.isArray(details.families) && details.families.length
      ? `Familias: ${details.families.join(', ')}`
      : null;

    return [
      details.parameter_size ? `Parámetros: ${details.parameter_size}` : null,
      details.quantization ? `Cuantización: ${details.quantization}` : null,
      sizeLabel ? `Tamaño: ${sizeLabel}` : null,
      modifiedAt ? `Actualizado: ${modifiedAt}` : null,
      families,
      details.family ? `Familia principal: ${details.family}` : null,
      raw.digest ? `Digest: ${raw.digest}` : null,
    ].filter(Boolean);
  }

  function describeLitellmModel(litellmModel = {}) {
    const capabilityList = Array.isArray(litellmModel.capabilities) ? litellmModel.capabilities.join(', ') : '';
    const parts = [
      litellmModel.model_type ? `Tipo: ${litellmModel.model_type}` : null,
      litellmModel.context_window ? `Contexto: ${litellmModel.context_window.toLocaleString()} tokens` : null,
      litellmModel.max_output_tokens ? `Salida máxima: ${litellmModel.max_output_tokens.toLocaleString()} tokens` : null,
      capabilityList ? `Capacidades: ${capabilityList}` : null,
    ].filter(Boolean);

    return parts.length > 0 ? parts.join(' · ') : 'No se encontraron campos compatibles con LiteLLM.';
  }

  function renderModels(container, sourceModels) {
    const content = container.querySelector('.models-content');
    const lastSynced = container.dataset.lastSynced;

    if (!sourceModels || !Array.isArray(sourceModels.models) || sourceModels.models.length === 0) {
      content.innerHTML = '<p class="muted">No models fetched yet for this provider.</p>';
      return;
    }

    const fetchedAt = sourceModels.fetched_at || lastSynced || '';
    const items = sourceModels.models
      .map((model) => {
        const ctx = model.context_window ? `Ctx: ${model.context_window.toLocaleString()} tokens` : '';
        const maxOut = model.max_output_tokens ? `Max output: ${model.max_output_tokens.toLocaleString()} tokens` : '';
        const caps = Array.isArray(model.capabilities) && model.capabilities.length > 0 ? `Capabilities: ${model.capabilities.join(', ')}` : '';
        const tagSummary = buildTagSummary(model.raw);
        const badges = [ctx, maxOut, caps, ...tagSummary]
          .filter(Boolean)
          .map((badge) => `<span class="badge">${badge}</span>`)
          .join('');

        const summaryText = tagSummary.length > 0 ? tagSummary.join(' · ') : 'Metadatos básicos no disponibles en /api/tags.';
        return `
          <li class="model-card">
            <div class="model-card__header">
              <div>${model.id}</div>
              <div class="model-card__meta">${badges}</div>
            </div>
            <div class="model-card__body">${summaryText}</div>
            <div class="model-card__actions">
              <button type="button" class="model-more-info" data-source-name="${container.dataset.sourceName}" data-model-id="${model.id}">Más info</button>
            </div>
            <details class="model-card__details" hidden>
              <summary>Detalles extendidos</summary>
              <pre class="model-card__body"></pre>
            </details>
          </li>
        `;
      })
      .join('');

    content.innerHTML = `
      <p class="muted">Last fetched at ${fetchedAt}</p>
      <ul class="model-cards">${items}</ul>
    `;

    bindModelDetails(container);
  }

  async function loadModels() {
    try {
      const response = await fetch(modelsEndpoint, { headers: { Accept: 'application/json' } });
      if (!response.ok) return;

      const payload = await response.json();
      document.querySelectorAll('.models-area').forEach((container) => {
        const sourceName = container.dataset.sourceName;
        renderModels(container, payload[sourceName]);
      });
    } catch (error) {
      console.error('Failed loading models', error);
    }
  }

  async function refreshSource(form) {
    const formData = new FormData(form);
    await fetch(form.action, { method: 'POST', body: formData });
    await loadModels();
  }

  function bindModelDetails(container) {
    container.querySelectorAll('.model-more-info').forEach((button) => {
      button.addEventListener('click', async () => {
        const sourceName = button.dataset.sourceName;
        const modelId = button.dataset.modelId;
        const card = button.closest('.model-card');
        const details = card.querySelector('.model-card__details');
        const target = details.querySelector('pre');

        details.hidden = false;
        details.open = true;
        target.textContent = 'Cargando información...';

        try {
          const params = new URLSearchParams({ source: sourceName, model: modelId });
          const response = await fetch(`${modelDetailsEndpoint}?${params.toString()}`, {
            headers: { Accept: 'application/json' },
          });
          if (!response.ok) {
            target.textContent = `No se pudo cargar la información (${response.status}).`;
            return;
          }

          const payload = await response.json();
          const litellmMapping = describeLitellmModel(payload?.litellm_model || {});
          const rawDetails = payload?.raw || payload || {};

          target.textContent = [
            'Datos mapeables a LiteLLM:',
            litellmMapping,
            '',
            'Modelo normalizado para LiteLLM:',
            JSON.stringify(payload?.litellm_model || {}, null, 2),
            '',
            'Respuesta completa de Ollama:',
            JSON.stringify(rawDetails, null, 2),
          ].join('\n');
        } catch (error) {
          console.error('Failed loading model details', error);
          target.textContent = 'No se pudo cargar la información extendida.';
        }
      });
    });
  }

  document.querySelectorAll('.refresh-form').forEach((form) => {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      await refreshSource(form);
    });
  });

  document.addEventListener('DOMContentLoaded', loadModels);
</script>
{% endblock %}
