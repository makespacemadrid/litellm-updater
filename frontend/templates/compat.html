{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Compatibility Models</h2>
  <p class="muted">
    Map standard OpenAI model names (like "gpt-4", "gpt-3.5-turbo") to your actual models in the database.
    This allows external services to use familiar model names while routing to your custom models.
  </p>

  <!-- Actions -->
  <div class="compat-actions">
    <button class="btn-primary" onclick="openAddCompatModal()">Add Compat Model</button>
    <button class="btn-secondary" onclick="registerDefaultModels()" style="background: #2e7d32;">
      Register Default OpenAI Models
    </button>
  </div>

  <!-- Compat Models List -->
  <div id="compat-list">Loading compat models...</div>
</section>

<!-- Add/Edit Compat Model Modal -->
<div id="compat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="compat-modal-title">Add Compat Model</h3>
      <span class="close" onclick="closeCompatModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="compat-form" onsubmit="saveCompatModel(event)">
        <input type="hidden" id="compat-model-id" />

        <label>Model Name <span style="color: red;">*</span></label>
        <input type="text" id="compat-name" list="openai-models" placeholder="gpt-4, gpt-3.5-turbo, whisper-1, etc." required />
        <datalist id="openai-models">
          <option value="gpt-4">
          <option value="gpt-4-turbo">
          <option value="gpt-4-turbo-preview">
          <option value="gpt-3.5-turbo">
          <option value="gpt-3.5-turbo-16k">
          <option value="whisper-1">
          <option value="tts-1">
          <option value="tts-1-hd">
          <option value="dall-e-3">
          <option value="dall-e-2">
          <option value="text-embedding-3-small">
          <option value="text-embedding-3-large">
          <option value="text-embedding-ada-002">
        </datalist>
        <p class="muted" style="margin-top: -0.5rem; margin-bottom: 1rem;">
          The name external services will use (e.g., "gpt-4", "gpt-3.5-turbo"). Select from common OpenAI models or enter a custom name.
        </p>

        <label>Map to Provider</label>
        <select id="compat-provider">
          <option value="">-- No mapping (direct LiteLLM model) --</option>
        </select>

        <label>Map to Model</label>
        <select id="compat-mapped-model">
          <option value="">-- Select provider first --</option>
        </select>
        <p class="muted" style="margin-top: -0.5rem; margin-bottom: 1rem;">
          The actual model in your database that will handle requests
        </p>

        <label>Access Groups (comma separated)</label>
        <input type="text" id="compat-access-groups" value="compat" placeholder="compat, premium" />

        <div class="modal-actions">
          <button type="button" onclick="closeCompatModal()">Cancel</button>
          <button type="submit" class="btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.compat-actions {
  margin-bottom: 1.5rem;
}

.compat-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.compat-table th,
.compat-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.compat-table th {
  background: #f5f5f5;
  font-weight: 600;
}

.compat-table tr:hover {
  background: #fafafa;
}

.compat-row-actions {
  display: flex;
  gap: 0.5rem;
}

.compat-row-actions button {
  padding: 0.4rem 0.8rem;
  font-size: 0.85rem;
}

.badge-mapping {
  background: #1976d2;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 3px;
  font-size: 0.85rem;
}

.badge-direct {
  background: #666;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 3px;
  font-size: 0.85rem;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 0;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.modal-header h3 {
  margin: 0;
}

.modal-body {
  padding: 1.5rem;
}

.modal-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
}

.close {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover,
.close:focus {
  color: #000;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

input[type="text"],
select {
  width: 100%;
  padding: 0.5rem;
  margin-bottom: 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.btn-primary {
  background: #1976d2;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-primary:hover {
  background: #1565c0;
}

.btn-danger {
  background: #d32f2f;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-danger:hover {
  background: #b71c1c;
}

.btn-secondary {
  background: #757575;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-secondary:hover {
  background: #616161;
}

.muted {
  color: #666;
  font-size: 0.9rem;
}
</style>

<script>
let compatModels = [];
let allProviders = [];
let providerModels = {};

// Load compat models on page load
async function loadCompatModels() {
  try {
    const response = await fetch('/api/compat/models');
    compatModels = await response.json();
    renderCompatModels();
  } catch (error) {
    document.getElementById('compat-list').innerHTML = `<p style="color: red;">Error loading compat models: ${error.message}</p>`;
  }
}

// Load all providers for dropdown
async function loadProviders() {
  try {
    const response = await fetch('/api/providers');
    allProviders = await response.json();

    // Filter out compat provider from the list
    allProviders = allProviders.filter(p => p.type !== 'compat');

    updateProviderDropdown();
  } catch (error) {
    console.error('Error loading providers:', error);
  }
}

function updateProviderDropdown() {
  const select = document.getElementById('compat-provider');
  const currentValue = select.value;

  select.innerHTML = '<option value="">-- No mapping (direct LiteLLM model) --</option>';

  allProviders.forEach(provider => {
    const option = document.createElement('option');
    option.value = provider.id;
    option.textContent = `${provider.name} (${provider.type})`;
    select.appendChild(option);
  });

  if (currentValue) {
    select.value = currentValue;
  }
}

// Load models for selected provider
async function loadProviderModels(providerId) {
  if (!providerId) {
    document.getElementById('compat-mapped-model').innerHTML = '<option value="">-- Select provider first --</option>';
    return;
  }

  if (providerModels[providerId]) {
    updateModelDropdown(providerId);
    return;
  }

  try {
    const response = await fetch(`/api/providers/${providerId}/models?include_orphaned=false`);
    const data = await response.json();
    providerModels[providerId] = Array.isArray(data) ? data : (data.models || []);
    updateModelDropdown(providerId);
  } catch (error) {
    console.error('Error loading provider models:', error);
  }
}

function updateModelDropdown(providerId) {
  const select = document.getElementById('compat-mapped-model');
  const models = providerModels[providerId] || [];

  select.innerHTML = '<option value="">-- Select a model --</option>';

  models.forEach(model => {
    const option = document.createElement('option');
    option.value = model.model_id;
    option.textContent = model.display_name || model.model_id;
    select.appendChild(option);
  });
}

function renderCompatModels() {
  const container = document.getElementById('compat-list');

  if (compatModels.length === 0) {
    container.innerHTML = '<p class="muted">No compat models defined yet. Click "Add Compat Model" to create one.</p>';
    return;
  }

  const rows = compatModels.map(model => {
    const mappingBadge = model.mapped_provider
      ? `<span class="badge-mapping">${model.mapped_provider.name} → ${model.mapped_model_id}</span>`
      : `<span class="badge-direct">Direct LiteLLM</span>`;

    const accessGroups = model.access_groups && model.access_groups.length > 0
      ? model.access_groups.join(', ')
      : '<span class="muted">None</span>';

    return `
      <tr>
        <td><strong>${model.model_name}</strong></td>
        <td>${mappingBadge}</td>
        <td>${accessGroups}</td>
        <td>
          <div class="compat-row-actions">
            <button class="btn-primary" onclick="editCompatModel(${model.id})">Edit</button>
            <button class="btn-danger" onclick="deleteCompatModel(${model.id}, '${model.model_name}')">Delete</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  container.innerHTML = `
    <table class="compat-table">
      <thead>
        <tr>
          <th>Model Name</th>
          <th>Mapping</th>
          <th>Access Groups</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}

function openAddCompatModal() {
  document.getElementById('compat-modal-title').textContent = 'Add Compat Model';
  document.getElementById('compat-form').reset();
  document.getElementById('compat-model-id').value = '';
  document.getElementById('compat-access-groups').value = 'compat';  // Set default access group
  document.getElementById('compat-modal').style.display = 'block';
  updateProviderDropdown();
}

async function editCompatModel(modelId) {
  const model = compatModels.find(m => m.id === modelId);
  if (!model) return;

  document.getElementById('compat-modal-title').textContent = 'Edit Compat Model';
  document.getElementById('compat-model-id').value = model.id;
  document.getElementById('compat-name').value = model.model_name;
  document.getElementById('compat-access-groups').value = model.access_groups ? model.access_groups.join(', ') : '';

  if (model.mapped_provider) {
    document.getElementById('compat-provider').value = model.mapped_provider.id;
    await loadProviderModels(model.mapped_provider.id);
    document.getElementById('compat-mapped-model').value = model.mapped_model_id || '';
  }

  document.getElementById('compat-modal').style.display = 'block';
}

function closeCompatModal() {
  document.getElementById('compat-modal').style.display = 'none';
}

async function saveCompatModel(event) {
  event.preventDefault();

  const modelId = document.getElementById('compat-model-id').value;
  const modelName = document.getElementById('compat-name').value;
  const providerId = document.getElementById('compat-provider').value;
  const mappedModelId = document.getElementById('compat-mapped-model').value;
  const accessGroups = document.getElementById('compat-access-groups').value;

  const formData = new FormData();
  formData.append('model_name', modelName);
  if (providerId) formData.append('mapped_provider_id', providerId);
  if (mappedModelId) formData.append('mapped_model_id', mappedModelId);
  if (accessGroups) formData.append('access_groups', accessGroups);

  try {
    const url = modelId ? `/api/compat/models/${modelId}` : '/api/compat/models';
    const method = modelId ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method: method,
      body: formData
    });

    const result = await response.json();

    if (response.ok) {
      alert(`✓ ${result.message}`);
      closeCompatModal();
      await loadCompatModels();
    } else {
      alert(`✗ Failed: ${result.detail || 'Unknown error'}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

async function deleteCompatModel(modelId, modelName) {
  if (!confirm(`Are you sure you want to delete compat model "${modelName}"?`)) {
    return;
  }

  try {
    const response = await fetch(`/api/compat/models/${modelId}`, {
      method: 'DELETE'
    });

    const result = await response.json();

    if (response.ok) {
      alert(`✓ ${result.message}`);
      await loadCompatModels();
    } else {
      alert(`✗ Delete failed: ${result.detail || 'Unknown error'}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

// Handle provider selection change
document.addEventListener('DOMContentLoaded', () => {
  loadCompatModels();
  loadProviders();

  const providerSelect = document.getElementById('compat-provider');
  providerSelect.addEventListener('change', (e) => {
    loadProviderModels(e.target.value);
  });
});

// Register all default OpenAI-compatible models
async function registerDefaultModels() {
  if (!confirm('This will add 17 default OpenAI-compatible model mappings (gpt-4, gpt-3.5-turbo, o1, etc.) to the compat provider. Continue?')) {
    return;
  }

  try {
    const response = await fetch('/api/compat/register-defaults', {
      method: 'POST'
    });

    const result = await response.json();

    if (response.ok) {
      const msg = `✓ ${result.message}\n\n` +
                  `Created: ${result.created}\n` +
                  `Skipped: ${result.skipped.length}\n\n` +
                  `Summary:\n` +
                  `- Chat models: ${result.summary.chat || 0}\n` +
                  `- Vision models: ${result.summary.vision || 0}\n` +
                  `- Embedding models: ${result.summary.embedding || 0}\n` +
                  `- Reasoning models: ${result.summary.reasoning || 0}\n` +
                  `- Code models: ${result.summary.code || 0}`;

      let fullMsg = msg;
      if (result.skipped.length > 0) {
        fullMsg += '\n\nSkipped models:\n' + result.skipped.join('\n');
      }
      if (result.results.errors.length > 0) {
        fullMsg += '\n\nErrors:\n' + result.results.errors.join('\n');
      }

      alert(fullMsg);

      // Reload the compat models list
      await loadCompatModels();
    } else {
      alert(`✗ Failed to register default models: ${result.detail || 'Unknown error'}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('compat-modal');
  if (event.target === modal) {
    closeCompatModal();
  }
}
</script>

{% endblock %}
